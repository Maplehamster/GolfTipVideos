<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leadership Conversation Coach</title>
<style>
  :root{ --bg:#0f1720; --card:#1b2733; --ink:#e6f0f8; --muted:#9fb3c8; --accent:#3aa675; --line:#233647; --pill:#1a2430; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:850px;margin:0 auto;padding:16px 16px 112px}
  header{display:flex;align-items:center;gap:10px;padding:12px 0;flex-wrap:wrap}
  a.home{color:var(--muted);text-decoration:none;border:1px solid #294355;padding:6px 10px;border-radius:10px}
  h1{margin:0;font-size:20px}
  .hint{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);border:1px solid #2a3e52;color:var(--muted);padding:6px 10px;border-radius:999px;font-size:13px}
  .btn{background:var(--accent);color:#03150d;border:none;padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#2f4a60;color:#d5e6f2;border:1px solid #355a71}
  .btn.armed{outline:2px solid #6ec1ff}
  .slider{display:flex;align-items:center;gap:10px}
  input[type="range"]{width:220px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;min-height:55vh}
  .messages{display:flex;flex-direction:column;gap:10px}
  .msg{padding:10px 12px;border-radius:12px;max-width:80%;white-space:pre-wrap}
  .you{align-self:flex-end;background:#25394a;border:1px solid #2f4a60}
  .bot{align-self:flex-start;background:#1a2430;border:1px solid #2a3e52}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 0}
  .chip{border:1px dashed #2d475a;color:var(--muted);padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
  .chip:hover{border-style:solid;color:var(--ink)}
  .dock{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,transparent,rgba(15,23,32,.9) 20%, rgba(15,23,32,1) 60%);padding:16px}
  .bar{max-width:850px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:14px;display:flex;gap:8px;padding:8px}
  textarea{flex:1;resize:none;background:transparent;border:none;color:var(--ink);height:60px;outline:none;padding:8px}
  audio{display:none}
</style>
<link rel="icon" href="/GolfTipVideos/favicon.svg" type="image/svg+xml">
</head>
<body>
<div class="wrap">
  <header>
    <a class="home" href="/GolfTipVideos/index.html">‚Üê Home</a>
    <h1>Leadership Conversation Coach</h1>
    <div class="hint">Pause or stop at any time ‚Äî say ‚Äúpause‚Äù for tips or ‚Äústop‚Äù to end the round.</div>

    <div class="controls" style="width:100%;justify-content:space-between">
      <div class="controls">
        <button id="prepBtn" class="btn secondary">Prep</button>
        <button id="roleBtn" class="btn secondary">Role-play</button>
        <button id="feedBtn" class="btn secondary">Feedback</button>
        <span class="pill"><span>üéØ</span> Stage: <strong id="stageLabel">Prep</strong></span>
      </div>
      <div class="controls">
        <div class="slider">
          <label class="hint" for="difficulty">Difficulty</label>
          <input id="difficulty" type="range" min="1" max="10" value="5" />
          <span class="pill">Level: <strong id="diffVal">5</strong>/10</span>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="voiceBtn" class="btn">üéôÔ∏è Start Voice</button>
      <button id="stopBtn" class="btn secondary">‚èπ Stop</button>
      <span class="pill" id="rtcStatus">Idle</span>
    </div>
  </header>

  <div class="card">
    <div id="messages" class="messages">
      <div class="msg bot">üëã I‚Äôm your prep coach. Set the scene: who are you talking to and what‚Äôs the topic?</div>
      <div class="msg bot">Tip: In role-play say ‚Äúpause‚Äù for ideas or ‚Äústop‚Äù to end the round.</div>
    </div>

    <div class="row">
      <div class="chip" data-insert="Purpose: ‚Ä¶  Desired outcome: ‚Ä¶">Prompt: Purpose/Outcome</div>
      <div class="chip" data-insert="Difficulty (1‚Äì10): ‚Ä¶  Pushbacks I expect: ‚Ä¶">Prompt: Difficulty</div>
      <div class="chip" data-insert="Draft opener: ‚Äú‚Ä¶‚Äù  Risks: ‚Ä¶  Must-say points: ‚Ä¶">Prompt: Openers</div>
    </div>
  </div>
</div>

<div class="dock">
  <div class="bar">
    <textarea id="input" placeholder="Speak‚Ä¶ or type and press Enter"></textarea>
    <button id="sendBtn" class="btn">Send</button>
  </div>
</div>

<audio id="assistantAudio" autoplay></audio>

<script>
// üîß YOUR Worker URL:
const WORKER_SESSION_URL = "https://voice-ticket.burmans2006.workers.dev/session";
const REALTIME_URL = "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview";

// UI refs
const els = {
  messages: document.getElementById("messages"),
  input: document.getElementById("input"),
  send: document.getElementById("sendBtn"),
  voice: document.getElementById("voiceBtn"),
  stop: document.getElementById("stopBtn"),
  rtcStatus: document.getElementById("rtcStatus"),
  prep: document.getElementById("prepBtn"),
  role: document.getElementById("roleBtn"),
  feed: document.getElementById("feedBtn"),
  stageLabel: document.getElementById("stageLabel"),
  difficulty: document.getElementById("difficulty"),
  diffVal: document.getElementById("diffVal"),
  audio: document.getElementById("assistantAudio"),
};

// Helpers
function addMsg(text, who="bot"){
  const div = document.createElement("div");
  div.className = `msg ${who}`; div.textContent = text;
  els.messages.appendChild(div);
  els.messages.scrollTop = els.messages.scrollHeight;
}
function phaseEnvelope(userText) {
  return `[phase:${stage}] [difficulty:${els.difficulty.value}] ${userText}`;
}

// Stage state
let stage = "prep";
function setStage(s){
  stage = s;
  [els.prep, els.role, els.feed].forEach(b=>b.classList.remove("armed"));
  if(s==="prep") els.prep.classList.add("armed");
  if(s==="roleplay") els.role.classList.add("armed");
  if(s==="feedback") els.feed.classList.add("armed");
  els.stageLabel.textContent = s==="roleplay" ? "Role-play" : s[0].toUpperCase()+s.slice(1);
  addMsg(`Stage set to ${els.stageLabel.textContent}.`, "bot");
  // Nudge the next server turn with a tiny reminder
  if (dc && dc.readyState === "open") {
    dc.send(JSON.stringify({ type: "input_text", text: phaseEnvelope("(stage changed)") }));
  }
}
els.prep.addEventListener("click", ()=>setStage("prep"));
els.role.addEventListener("click", ()=>setStage("roleplay"));
els.feed.addEventListener("click", ()=>setStage("feedback"));
els.difficulty.addEventListener("input", ()=>{ els.diffVal.textContent = els.difficulty.value; });

// Chips (quick inserts)
document.querySelectorAll(".chip").forEach(c =>
  c.addEventListener("click", () => {
    els.input.value = (els.input.value + " " + c.dataset.insert).trim();
    els.input.focus();
  })
);

// Realtime voice (WebRTC)
let pc, dc, micStream;

async function startVoice(){
  if(pc) return;
  els.rtcStatus.textContent = "Connecting‚Ä¶";

  // Ask Worker for a short-lived session ticket (pinned rules + tool)
  const sess = await fetch(WORKER_SESSION_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ stage, difficulty: Number(els.difficulty.value) })
  }).then(r=>r.json()).catch(()=>null);

  const EPHEMERAL_KEY = sess?.client_secret?.value;
  if(!EPHEMERAL_KEY){ els.rtcStatus.textContent = "No session ticket"; return; }

  micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true } });

  pc = new RTCPeerConnection();
  const inbound = new MediaStream();
  els.audio.srcObject = inbound;
  pc.ontrack = (e)=> inbound.addTrack(e.track);
  micStream.getTracks().forEach(t=> pc.addTrack(t, micStream));
  pc.onconnectionstatechange = ()=> els.rtcStatus.textContent = `RTC: ${pc.connectionState}`;

  // Data channel for events
  dc = pc.createDataChannel("oai-events");
  dc.onopen = () => {
    // Kick off with a short, phase-scoped prompt
    const line =
      stage === "roleplay" ? "Okay, I‚Äôll play the team member. Start when you‚Äôre ready."
      : stage === "feedback" ? "Tell me what happened and I‚Äôll give specific feedback."
      : "Let‚Äôs prep. What‚Äôs your purpose and desired outcome?";
    dc.send(JSON.stringify({ type: "input_text", text: phaseEnvelope(line) }));
    addMsg(line, "bot");
  };
  dc.onmessage = (ev) => handleOAIEvent(ev.data);

  // Create offer ‚Üí send to OpenAI ‚Üí set answer
  const offer = await pc.createOffer({ offerToReceiveAudio: true });
  await pc.setLocalDescription(offer);
  const answerSDP = await fetch(REALTIME_URL, {
    method: "POST",
    headers: { Authorization: `Bearer ${EPHEMERAL_KEY}`, "Content-Type": "application/sdp" },
    body: offer.sdp
  }).then(r=>r.text());
  await pc.setRemoteDescription({ type: "answer", sdp: answerSDP });
}

function stopVoice(){
  if(pc){ pc.close(); pc=null; }
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  els.rtcStatus.textContent = "Stopped";
}

els.voice.addEventListener("click", startVoice);
els.stop.addEventListener("click", stopVoice);

// Text input alongside voice
function sendText(){
  const text = els.input.value.trim();
  if(!text) return;
  addMsg(text, "you");
  els.input.value = "";
  if(dc && dc.readyState === "open"){
    dc.send(JSON.stringify({ type: "input_text", text: phaseEnvelope(text) }));
  } else {
    addMsg("(Click ‚ÄòStart Voice‚Äô to connect the coach.)", "bot");
  }
}
els.send.addEventListener("click", sendText);
els.input.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendText(); }});

// Robust handler for tool calls (covers several event shapes)
function handleOAIEvent(raw){
  let msg; try { msg = JSON.parse(raw); } catch { return; }

  // 1) Direct tool call (simple case)
  if (msg.type === "tool_call" && msg.name === "coach_emit") {
    renderCoach(msg.arguments);
    return;
  }

  // 2) Realtime "response.function_call" shape
  if (msg.type === "response.function_call" && msg.name === "coach_emit") {
    const args = safeParseJSON(msg.arguments);
    renderCoach(args);
    return;
  }

  // 3) Some versions stream function tool as deltas; we accumulate
  if (msg.type === "response.delta" && msg.delta?.type === "function_call") {
    accFunc = accFunc || { name: msg.delta.name, argsText: "" };
    if (msg.delta.arguments) accFunc.argsText += msg.delta.arguments;
    return;
  }
  if (msg.type === "response.message.completed" && accFunc?.name === "coach_emit") {
    const args = safeParseJSON(accFunc.argsText);
    accFunc = null;
    renderCoach(args);
    return;
  }

  // 4) Plain text fallback (shouldn't happen because of tool-only rule, but keep it friendly)
  if (msg.type === "response.output_text") {
    const t = Array.isArray(msg.text) ? msg.text.join("") : String(msg.text || "");
    if (t.trim()) addMsg(t.trim(), "bot");
    return;
  }

  // Uncomment to debug unknown events:
  // console.log("OAI EVT:", msg);
}
let accFunc = null;

function safeParseJSON(s) {
  try { return JSON.parse(s); } catch { return null; }
}
function renderCoach(args) {
  if (!args) return;
  const { phase, speech, break_character, tips } = args;
  if (phase && ["prep","roleplay","feedback"].includes(phase)) {
    // keep UI in sync if model transitions
    setStage(phase);
  }
  if (speech) addMsg(speech, "bot");
  if (break_character && tips) addMsg(`Tip: ${tips}`, "bot");
}

// Default stage
setStage("prep");
</script>
</body>
</html>

