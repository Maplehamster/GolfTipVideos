<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leadership Conversation Coach</title>
<link rel="icon" href="/GolfTipVideos/favicon.svg" type="image/svg+xml">
<style>
  :root{ --bg:#0f1720; --card:#1b2733; --ink:#e6f0f8; --muted:#9fb3c8; --accent:#3aa675; --line:#233647; --pill:#1a2430; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif}
  .wrap{max-width:850px;margin:0 auto;padding:16px 16px 112px}
  header{display:flex;align-items:center;gap:10px;padding:12px 0;flex-wrap:wrap}
  a.home{color:var(--muted);text-decoration:none;border:1px solid #294355;padding:6px 10px;border-radius:10px}
  h1{margin:0;font-size:20px}
  .hint{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);border:1px solid #2a3e52;color:var(--muted);padding:6px 10px;border-radius:999px;font-size:13px}
  .btn{background:var(--accent);color:#03150d;border:none;padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#2f4a60;color:#d5e6f2;border:1px solid #355a71}
  .btn.armed{outline:2px solid #6ec1ff}
  .slider{display:flex;align-items:center;gap:10px}
  input[type="range"]{width:220px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;min-height:55vh}
  .messages{display:flex;flex-direction:column;gap:10px}
  .msg{padding:10px 12px;border-radius:12px;max-width:80%;white-space:pre-wrap}
  .you{align-self:flex-end;background:#25394a;border:1px solid #2f4a60}
  .bot{align-self:flex-start;background:#1a2430;border:1px solid #2a3e52}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 0}
  .chip{border:1px dashed #2d475a;color:var(--muted);padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
  .chip:hover{border-style:solid;color:var(--ink)}
  .dock{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,transparent,rgba(15,23,32,.9) 20%, rgba(15,23,32,1) 60%);padding:16px}
  .bar{max-width:850px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:14px;display:flex;gap:8px;padding:8px}
  textarea{flex:1;resize:none;background:transparent;border:none;color:var(--ink);height:60px;outline:none;padding:8px}
  audio{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <a class="home" href="/GolfTipVideos/index.html">‚Üê Home</a>
    <h1>Leadership Conversation Coach</h1>
    <div class="hint">Say ‚Äúpause‚Äù for tips or ‚Äústop‚Äù to end the round.</div>

    <div class="controls" style="width:100%;justify-content:space-between">
      <div class="controls">
        <button id="prepBtn" class="btn secondary">Prep</button>
        <button id="roleBtn" class="btn secondary">Role‚Äëplay</button>
        <button id="feedBtn" class="btn secondary">Feedback</button>
        <span class="pill"><span>üéØ</span> Stage: <strong id="stageLabel">Prep</strong></span>
      </div>
      <div class="controls">
        <div class="slider">
          <label class="hint" for="difficulty">Difficulty</label>
          <input id="difficulty" type="range" min="1" max="10" value="5" />
          <span class="pill">Level: <strong id="diffVal">5</strong>/10</span>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="voiceBtn" class="btn">üéôÔ∏è Start Voice</button>
      <button id="stopBtn" class="btn secondary">‚èπ Stop</button>
      <button id="nudgeBtn" class="btn secondary">Reply ‚ñ∂</button>
      <span class="pill" id="rtcStatus">Idle</span>
    </div>
  </header>

  <div class="card">
    <div id="messages" class="messages">
      <div class="msg bot">üëã I‚Äôm your prep coach. Set the scene: who are you talking to and what‚Äôs the topic?</div>
      <div class="msg bot">Tip: In role‚Äëplay say ‚Äúpause‚Äù for ideas or ‚Äústop‚Äù to end the round.</div>
    </div>

    <div class="row">
      <div class="chip" data-insert="Purpose: ‚Ä¶  Desired outcome: ‚Ä¶">Prompt: Purpose/Outcome</div>
      <div class="chip" data-insert="Difficulty (1‚Äì10): ‚Ä¶  Pushbacks I expect: ‚Ä¶">Prompt: Difficulty</div>
      <div class="chip" data-insert="Draft opener: ‚Äú‚Ä¶‚Äù  Risks: ‚Ä¶  Must‚Äësay points: ‚Ä¶">Prompt: Openers</div>
    </div>
  </div>
</div>

<div class="dock">
  <div class="bar">
    <textarea id="input" placeholder="Speak‚Ä¶ or type and press Enter"></textarea>
    <button id="sendBtn" class="btn">Send</button>
  </div>
</div>

<audio id="assistantAudio" autoplay></audio>

<script>
// ===== CONFIG =====
const WORKER_SESSION_URL = "https://voice-ticket.burmans2006.workers.dev/session"; // must end with /session
const REALTIME_URL = "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview";

// ===== UI refs =====
const els = {
  messages: document.getElementById("messages"),
  input: document.getElementById("input"),
  send: document.getElementById("sendBtn"),
  voice: document.getElementById("voiceBtn"),
  stop: document.getElementById("stopBtn"),
  rtcStatus: document.getElementById("rtcStatus"),
  prep: document.getElementById("prepBtn"),
  role: document.getElementById("roleBtn"),
  feed: document.getElementById("feedBtn"),
  stageLabel: document.getElementById("stageLabel"),
  difficulty: document.getElementById("difficulty"),
  diffVal: document.getElementById("diffVal"),
  audio: document.getElementById("assistantAudio"),
};

// ===== helpers =====
function addMsg(text, who="bot"){
  const div = document.createElement("div");
  div.className = `msg ${who}`;
  div.textContent = text;
  els.messages.appendChild(div);
  els.messages.scrollTop = els.messages.scrollHeight;
}

function phaseEnvelope(text){
  return `[phase:${stage}] [difficulty:${els.difficulty.value}] ${text}`;
}

// chips quick insert
Array.from(document.querySelectorAll(".chip")).forEach(c =>
  c.addEventListener("click", () => {
    els.input.value = (els.input.value + " " + c.dataset.insert).trim();
    els.input.focus();
  })
);

// ===== Stage state =====
let stage = "prep";
function setStage(s){
  stage = s;
  [els.prep, els.role, els.feed].forEach(b=>b.classList.remove("armed"));
  if(s==="prep") els.prep.classList.add("armed");
  if(s==="roleplay") els.role.classList.add("armed");
  if(s==="feedback") els.feed.classList.add("armed");
  els.stageLabel.textContent = s==="roleplay" ? "Role‚Äëplay" : s[0].toUpperCase()+s.slice(1);
  addMsg(`Stage set to ${els.stageLabel.textContent}.`, "bot");
  if (dc && dc.readyState === "open") {
    dc.send(JSON.stringify({ type: "input_text", text: phaseEnvelope("(stage changed)") }));
    dc.send(JSON.stringify({ type: "response.create" }));
  }
}
els.prep.addEventListener("click", ()=>setStage("prep"));
els.role.addEventListener("click", ()=>setStage("roleplay"));
els.feed.addEventListener("click", ()=>setStage("feedback"));
els.difficulty.addEventListener("input", ()=> els.diffVal.textContent = els.difficulty.value);

// ===== Realtime Voice (WebRTC) =====
let pc, dc, rxDC, micStream;

async function startVoice(){
  if(pc) return;
  els.rtcStatus.textContent = "Connecting‚Ä¶";

  // 1) Get ephemeral ticket from your Worker
  let sess;
  try{
    const r = await fetch(WORKER_SESSION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ stage, difficulty: Number(els.difficulty.value) })
    });
    if(!r.ok){
      const t = await r.text();
      addMsg(`Ticket error ${r.status}: ${t.slice(0,200)}`, "bot");
      els.rtcStatus.textContent = "Worker error";
      return;
    }
    sess = await r.json();
  }catch(e){
    addMsg(`Ticket fetch failed: ${e.message||e}`, "bot");
    els.rtcStatus.textContent = "Worker error";
    return;
  }
  const EPHEMERAL_KEY = sess?.client_secret?.value;
  if(!EPHEMERAL_KEY){ addMsg("No session ticket from Worker.", "bot"); els.rtcStatus.textContent="No ticket"; return; }

  // 2) Mic permission
  try{
    micStream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true }});
  // Local VAD to auto-trigger replies when you stop speaking
  startLocalVAD(micStream);
  }catch(e){ addMsg(`Mic permission failed: ${e.message||e}`, "bot"); return; }

  // 3) PeerConnection + ensure we receive audio
  pc = new RTCPeerConnection();
  pc.addTransceiver("audio", { direction: "recvonly" });

  const inbound = new MediaStream();
  els.audio.srcObject = inbound;
  pc.ontrack = (e)=>{ inbound.addTrack(e.track); els.audio.play().catch(()=>{}); };
  pc.onconnectionstatechange = ()=> els.rtcStatus.textContent = `RTC: ${pc.connectionState}`;
  pc.ondatachannel = (ev)=>{ rxDC = ev.channel; rxDC.onmessage = (ev2)=> handleOAIEvent(ev2.data); };

  // add mic (uplink)
  micStream.getTracks().forEach(t=> pc.addTrack(t, micStream));

  // 4) Data channel we control for instructions + text
  dc = pc.createDataChannel("oai-events");
  dc.onopen = ()=>{
    const line =
      stage === "roleplay" ? "Okay, I‚Äôll play the team member. Start when you‚Äôre ready."
      : stage === "feedback" ? "Tell me what happened and I‚Äôll give specific feedback."
      : "Let‚Äôs prep. What‚Äôs your purpose and desired outcome?";
    dc.send(JSON.stringify({ type: "input_text", text: phaseEnvelope(line) }));
    dc.send(JSON.stringify({ type: "response.create" })); // ensure first reply
    addMsg(line, "bot");
  };
  dc.onmessage = (ev)=> handleOAIEvent(ev.data);
  dc.onerror = (e)=> addMsg(`DataChannel error: ${e.message||e}`, "bot");

  // 5) Offer/answer with Realtime
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  let answerSDP;
  try{
    const r = await fetch(REALTIME_URL, {
      method: "POST",
      headers: { Authorization: `Bearer ${EPHEMERAL_KEY}`, "Content-Type": "application/sdp" },
      body: offer.sdp
    });
    const text = await r.text();
    if(!r.ok){ addMsg(`Realtime error ${r.status}: ${text.slice(0,300)}`, "bot"); return; }
    answerSDP = text;
  }catch(e){ addMsg(`Realtime request failed: ${e.message||e}`, "bot"); return; }

  try{
    await pc.setRemoteDescription({ type: "answer", sdp: answerSDP });
  }catch(e){ addMsg(`Failed to apply remote SDP: ${e.message||e}`, "bot"); }
}

function stopVoice(){
  if(pc){ pc.close(); pc=null; }
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  els.rtcStatus.textContent = "Stopped";
}

els.voice.addEventListener("click", startVoice);
els.stop.addEventListener("click", stopVoice);

// ===== Text send =====
function sendText(){
  const text = els.input.value.trim();
  if(!text) return;
  addMsg(text, "you");
  els.input.value = "";
  if(dc && dc.readyState === "open"){
    dc.send(JSON.stringify({ type: "input_text", text: phaseEnvelope(text) }));
    dc.send(JSON.stringify({ type: "response.create" }));
  } else {
    addMsg("(Click ‚ÄòStart Voice‚Äô to connect the coach.)", "bot");
  }
}
els.send.addEventListener("click", sendText);
els.input.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendText(); }});

// ===== Event handling from Realtime =====
let accFunc = null;
function handleOAIEvent(raw){
  let msg; try { msg = JSON.parse(raw); } catch { return; }

  // direct tool call
  if (msg.type === "tool_call" && msg.name === "coach_emit") { renderCoach(msg.arguments); return; }
  // function_call shape
  if (msg.type === "response.function_call" && msg.name === "coach_emit") { renderCoach(safeJSON(msg.arguments)); return; }
  // streamed function args
  if (msg.type === "response.delta" && msg.delta?.type === "function_call") {
    accFunc = accFunc || { name: msg.delta.name, argsText: "" };
    if (msg.delta.arguments) accFunc.argsText += msg.delta.arguments;
    return;
  }
  if (msg.type === "response.message.completed" && accFunc?.name === "coach_emit") { renderCoach(safeJSON(accFunc.argsText)); accFunc=null; return; }

  // plain text fallback
  if (msg.type === "response.output_text") {
    const t = Array.isArray(msg.text) ? msg.text.join("") : String(msg.text || "");
    if (t.trim()) addMsg(t.trim(), "bot");
  }
}
function safeJSON(s){ try{ return JSON.parse(s) }catch{ return null } }

function renderCoach(args){
  if (!args) return;
  const { phase, speech, break_character, tips } = args;
  if (phase && ["prep","roleplay","feedback"].includes(phase)) setStage(phase);
  if (speech) addMsg(speech, "bot");
  if (break_character && tips) addMsg(`Tip: ${tips}`, "bot");
}

// --- local end-of-speech detector that nudges a reply ---
let _vadCtx,_vadAnalyser,_vadData,_speaking=false,_lastSound=0,_lastSent=0;
function startLocalVAD(stream){
  _vadCtx = new (window.AudioContext || window.webkitAudioContext)();
  const src = _vadCtx.createMediaStreamSource(stream);
  _vadAnalyser = _vadCtx.createAnalyser();
  _vadAnalyser.fftSize = 1024;
  _vadData = new Uint8Array(_vadAnalyser.fftSize);
  src.connect(_vadAnalyser);

  const SILENCE_MS = 400;      // pause length that ends your turn
  const MIN_GAP_MS = 900;      // cooldown between replies
  const THRESH = 12;           // lower = more sensitive (8‚Äì16 typical)

  function tick(){
    _vadAnalyser.getByteTimeDomainData(_vadData);
    let sum=0; for(let i=0;i<_vadData.length;i++){ const v=_vadData[i]-128; sum+=v*v; }
    const rms = Math.sqrt(sum/_vadData.length);
    const level = Math.min(100, Math.round((rms/22)*100)); // boost quiet mics

    const now = performance.now();
    if (level > THRESH) { _speaking = true; _lastSound = now; }
    else if (_speaking && (now - _lastSound) > SILENCE_MS) {
      _speaking = false;
      if (dc && dc.readyState === "open" && (now - _lastSent) > MIN_GAP_MS) {
        try { dc.send(JSON.stringify({ type: "response.create" })); } catch {}
        _lastSent = now;
      }
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

// Add click handler for manual nudge
const nudgeBtn = document.getElementById('nudgeBtn');
nudgeBtn.addEventListener('click', ()=>{
  if (dc && dc.readyState === 'open') {
    dc.send(JSON.stringify({ type: 'response.create' }));
  }
});

// default
setStage("prep");
</script>
</body>
</html>
