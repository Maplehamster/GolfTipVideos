<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Realtime Voice — Minimal Test</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0f1720;color:#e6f0f8;display:grid;place-items:center;height:100vh}
  .card{background:#1b2733;border:1px solid #233647;border-radius:14px;padding:18px;min-width:300px}
  button{cursor:pointer;border:1px solid #355a71;background:#3aa675;color:#03150d;font-weight:700;border-radius:10px;padding:10px 12px;margin-right:8px}
  button.secondary{background:#2f4a60;color:#d5e6f2}
  .row{margin:8px 0}
  .muted{color:#9fb3c8;font-size:12px}
</style>
</head>
<body>
  <div class="card">
    <div class="row"><strong>Realtime Voice — Minimal Test</strong></div>
    <div class="row">
      <button id="start">Start Voice</button>
      <button id="hello" class="secondary">Say “Hello”</button>
    </div>
    <div class="row muted">Status: <span id="status">Idle</span></div>
    <div class="row muted">Tip: click Start Voice once, then Say “Hello”.</div>
  </div>
  <audio id="a" autoplay></audio>
<script>
// === Config (use your Worker) ===
const WORKER_SESSION_URL = "https://voice-ticket.burmans2006.workers.dev/session"; // must end with /session
const REALTIME_URL = "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview";

const els = { start:document.getElementById('start'), hello:document.getElementById('hello'), status:document.getElementById('status'), a:document.getElementById('a') };
let pc, dc;

function setStatus(t){ els.status.textContent = t; }
function say(text){ if(dc && dc.readyState==='open'){ dc.send(JSON.stringify({type:'input_text', text})); dc.send(JSON.stringify({type:'response.create'})); } }

els.hello.onclick = () => say("Please say: Hello from the model in one short sentence.");
els.start.onclick = startVoice;

async function startVoice(){
  if(pc) return;
  setStatus('Getting ticket…');
  // 1) Ticket
  let ticket;
  try{
    const r = await fetch(WORKER_SESSION_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({stage:'prep',difficulty:5})});
    if(!r.ok){ setStatus('Ticket '+r.status); return; }
    ticket = await r.json();
  }catch(e){ setStatus('Ticket failed'); return; }
  const KEY = ticket?.client_secret?.value; if(!KEY){ setStatus('No ticket'); return; }

  // 2) Mic
  let mic; try{ mic = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true } }); }
  catch(e){ setStatus('Mic blocked'); return; }

  // 3) Peer connection with single sendrecv audio transceiver
  setStatus('Connecting RTC…');
  pc = new RTCPeerConnection();
  const inbound = new MediaStream(); els.a.srcObject = inbound; els.a.muted=false; els.a.volume=1;
  pc.ontrack = (e)=>{ inbound.addTrack(e.track); els.a.play().catch(()=>{}); };
  pc.onconnectionstatechange = ()=> setStatus('RTC: '+pc.connectionState);

  const micTrack = mic.getAudioTracks()[0];
  const tr = pc.addTransceiver('audio', { direction:'sendrecv' });
  await tr.sender.replaceTrack(micTrack);

  // Data channel for commands
  dc = pc.createDataChannel('oai-events');
  dc.onopen = ()=> setStatus('RTC: '+pc.connectionState+' | DC: open');

  // 4) Offer/Answer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  let answer;
  try{
    const r = await fetch(REALTIME_URL,{ method:'POST', headers:{ Authorization:'Bearer '+KEY, 'Content-Type':'application/sdp' }, body: offer.sdp });
    const txt = await r.text();
    if(!r.ok){ setStatus('Realtime '+r.status); return; }
    answer = txt;
  }catch(e){ setStatus('Realtime failed'); return; }
  try{ await pc.setRemoteDescription({ type:'answer', sdp:answer }); }
  catch(e){ setStatus('Bad SDP'); }
}
</script>
</body>
</html>

