<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Chat â€¢ Golf Tip Videos</title>
  <style>
    :root{
      --bg:#0f172a;         /* slate-900 */
      --panel:#111827;      /* gray-900 */
      --muted:#94a3b8;      /* slate-400 */
      --text:#e5e7eb;       /* gray-200 */
      --accent:#22c55e;     /* green-500 */
      --danger:#ef4444;     /* red-500 */
      --ring:#10b981;       /* emerald-500 */
    }
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b1220,#101827 35%,#0b1220);
      color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .app{width:min(900px,100%);}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .title{font-size:clamp(18px,2vw,22px); font-weight:700; letter-spacing:.4px}
    .status{font-size:14px; color:var(--muted)}

    .panel{margin-top:12px; background:color-mix(in hsl, var(--panel) 92%, black 8%); border-radius:20px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35)}

    /* Message stream (optional text events) */
    .stream{height:42vh; overflow:auto; padding-right:6px; border-radius:14px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,.06)}
    .msg{display:flex; gap:10px; padding:12px 14px; line-height:1.35;}
    .msg.you{background:rgba(34,197,94,.08)}
    .msg .who{font-weight:600; color:#93c5fd; min-width:56px}
    .msg.you .who{color:#86efac}
    .msg .text{white-space:pre-wrap}

    /* Big voice button */
    .controls{display:flex; flex-direction:column; align-items:center; gap:16px; padding:18px 0 4px}
    .mic-wrap{position:relative; width:140px; height:140px}
    .pulse{position:absolute; inset:0; border-radius:999px; filter:blur(16px);
      background:radial-gradient(50% 50% at 50% 50%, color-mix(in hsl, var(--accent) 50%, transparent) 0%, transparent 66%);
      opacity:.0; transition:opacity .25s ease;
    }
    .mic{position:absolute; inset:0; border-radius:50%; display:grid; place-items:center; cursor:pointer; user-select:none;
      background:linear-gradient(180deg, #111c2e, #0b1324); border:1px solid rgba(255,255,255,.08); box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 10px 30px rgba(0,0,0,.45);
      font-size:16px; color:var(--text); letter-spacing:.5px;
    }
    .mic span{display:block; font-weight:700}
    .mic:active{transform:scale(.98)}

    /* tiny waveform bars */
    .wave{display:flex; gap:4px; height:18px; align-items:flex-end}
    .bar{width:4px; height:4px; background:var(--ring); border-radius:2px; opacity:.7;}
    .bar:nth-child(1){animation:vu 1s infinite ease-in-out}
    .bar:nth-child(2){animation:vu .9s infinite ease-in-out .1s}
    .bar:nth-child(3){animation:vu 1.1s infinite ease-in-out .2s}
    .bar:nth-child(4){animation:vu .95s infinite ease-in-out .25s}
    .bar:nth-child(5){animation:vu 1.2s infinite ease-in-out .15s}
    @keyframes vu{0%,100%{height:4px}50%{height:18px}}

    .hint{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; justify-content:center}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.1); color:var(--text); background:transparent; cursor:pointer}
    .pill:hover{background:rgba(255,255,255,.06)}
    .pill.danger{border-color:rgba(239,68,68,.45); color:#fecaca}

    audio{display:none}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">Chat (Voice)</div>
      <div id="status" class="status">Idle</div>
    </div>

    <div class="panel">
      <div id="stream" class="stream" aria-live="polite" aria-atomic="false"></div>

      <div class="controls">
        <div class="mic-wrap">
          <div id="pulse" class="pulse"></div>
          <button id="toggleBtn" class="mic" aria-pressed="false" title="Start voice chat">
            <span id="btnLabel">Start Chat</span>
          </button>
        </div>
        <div class="wave" id="wave" aria-hidden="true" hidden>
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div class="row">
          <button id="hangupBtn" class="pill danger" hidden>End Chat</button>
          <button id="muteBtn" class="pill" hidden>Mute</button>
        </div>
        <div class="hint">Push the button to start. Grant mic permission. Click <b>End Chat</b> to stop.</div>
      </div>
    </div>
  </div>

  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
  /* === Configure this === */
 const EPHEMERAL_URL = "https://burmans2006.workers.dev/session"; // e.g. https://oai-voice-yourname.workers.dev/session
  const REALTIME_MODEL = "gpt-4o-realtime-preview"; // Check docs for latest model string
  const VOICE = "alloy"; // Voice name, see OpenAI docs

  /* === UI helpers === */
  const $ = (q) => document.querySelector(q);
  const status = (t) => { document.getElementById('status').textContent = t };
  const addLine = (who, text) => {
    if(!text) return;
    const s = document.getElementById('stream');
    const div = document.createElement('div');
    div.className = 'msg ' + (who==='You' ? 'you' : '');
    div.innerHTML = `<div class="who">${who}</div><div class="text">${text}</div>`;
    s.appendChild(div); s.scrollTop = s.scrollHeight;
  };

  let pc, localStream, dc, remoteStream, micTrack;
  let connected = false, isMuted = false;

  async function startChat(){
    if(connected) return;
    status('Connectingâ€¦');
    $('#btnLabel').textContent = 'Connectingâ€¦';
    $('#toggleBtn').setAttribute('aria-pressed','true');
    $('#wave').hidden = false; $('#pulse').style.opacity = .8;

    try{
      // Get microphone
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true, noiseSuppression: true, autoGainControl: true
        }
      });
      micTrack = localStream.getAudioTracks()[0];

      // Create peer connection
      pc = new RTCPeerConnection();
      // Send mic
      pc.addTrack(micTrack, localStream);

      // Receive AI audio
      remoteStream = new MediaStream();
      pc.addEventListener('track', (e)=>{
        remoteStream.addTrack(e.track);
      });
      const audioEl = document.getElementById('remoteAudio');
      audioEl.srcObject = remoteStream;

      // Optional: data channel for events/text
      dc = pc.createDataChannel('oai-events');
      dc.onmessage = (ev)=> {
        try {
          const msg = JSON.parse(ev.data);
          if(msg.type === 'response.delta' && msg.delta && msg.delta.type === 'output_text'){
            addLine('AI', msg.delta.text || '');
          } else if(msg.type === 'response.completed' && msg.response && msg.response.output_text){
            addLine('AI', msg.response.output_text);
          }
        } catch { /* ignore non-JSON */ }
      };

      // Create offer SDP
      const offer = await pc.createOffer({
        offerToReceiveAudio: true,
        voiceActivityDetection: true
      });
      await pc.setLocalDescription(offer);

      // Fetch ephemeral token for Realtime
      const sessRes = await fetch(EPHEMERAL_URL);
      if(!sessRes.ok) throw new Error('Failed to fetch session token');
      const session = await sessRes.json();
      const EPHEMERAL_KEY = session?.client_secret?.value || session?.client_secret || session?.value;
      if(!EPHEMERAL_KEY) throw new Error('Missing ephemeral key from server');

      // Send SDP offer to OpenAI Realtime (WebRTC/WHIP style)
      const realtimeUrl = `https://api.openai.com/v1/realtime?model=${encodeURIComponent(REALTIME_MODEL)}`;
      const ansRes = await fetch(realtimeUrl, {
        method: 'POST',
        body: offer.sdp,
        headers: {
          'Content-Type': 'application/sdp',
          'Authorization': `Bearer ${EPHEMERAL_KEY}`,
          'OpenAI-Beta': 'realtime=v1'
        }
      });
      if(!ansRes.ok){
        const t = await ansRes.text();
        throw new Error('Realtime answer failed: ' + t);
      }
      const answerSDP = await ansRes.text();
      await pc.setRemoteDescription({ type:'answer', sdp: answerSDP });

      connected = true;
      status('Listening');
      $('#btnLabel').textContent = 'Listeningâ€¦';
      $('#hangupBtn').hidden = false; $('#muteBtn').hidden = false;
      addLine('You', 'ðŸŽ¤ Voice chat started');
    }catch(err){
      console.error(err);
      status('Error: ' + (err?.message || err));
      $('#btnLabel').textContent = 'Start Chat';
      $('#toggleBtn').setAttribute('aria-pressed','false');
      $('#wave').hidden = true; $('#pulse').style.opacity = 0;
      addLine('AI', 'There was a connection error. Please try again.');
      cleanup();
    }
  }

  function endChat(){
    if(!connected) return;
    addLine('You', 'â›” Ended chat');
    status('Endingâ€¦');
    cleanup();
    status('Idle');
    $('#btnLabel').textContent = 'Start Chat';
    $('#toggleBtn').setAttribute('aria-pressed','false');
    $('#wave').hidden = true; $('#pulse').style.opacity = 0;
    $('#hangupBtn').hidden = true; $('#muteBtn').hidden = true;
  }

  function cleanup(){
    connected = false;
    if(dc){ try{ dc.close(); }catch{} dc = null; }
    if(pc){ try{ pc.close(); }catch{} pc = null; }
    if(micTrack){ try{ micTrack.stop(); }catch{} micTrack = null; }
    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
  }

  function toggleMute(){
    if(!micTrack) return;
    isMuted = !isMuted;
    micTrack.enabled = !isMuted;
    document.getElementById('muteBtn').textContent = isMuted ? 'Unmute' : 'Mute';
    status(isMuted ? 'Muted' : 'Listening');
  }

  // Wire up UI
  document.getElementById('toggleBtn').addEventListener('click', ()=>{
    if(connected) return; // when connected this button is read only
    startChat();
  });
  document.getElementById('hangupBtn').addEventListener('click', endChat);
  document.getElementById('muteBtn').addEventListener('click', toggleMute);

  // Allow spacebar to start/end
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'Space'){
      e.preventDefault();
      if(connected) endChat(); else startChat();
    }
  });
  </script>
</body>
</html>
