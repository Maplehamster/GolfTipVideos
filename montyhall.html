<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monty Hall — Visual Simulator & Tracker</title>
<style>
  :root{
    --bg:#0f1320; --panel:#171b2d; --muted:#96a0b5; --text:#e8ecf7; --primary:#6ea8ff;
    --green:#38b000; --red:#ff5d5d; --yellow:#ffd166; --border:#2a3250;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;justify-content:space-between;align-items:end;gap:16px;padding:20px 24px;border-bottom:1px solid var(--border)}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:14px;margin-top:6px}
  .legend{display:flex;gap:14px;align-items:center;color:var(--muted)}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;background:var(--muted)}
  .dot.switch{background:var(--green)}
  .dot.stick{background:var(--yellow)}
  .stage{display:grid;grid-template-columns:1fr 360px;gap:20px;padding:20px}
  @media (max-width:900px){.stage{grid-template-columns:1fr}}
  .board{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:18px}
  .panels{display:flex;flex-direction:column;gap:20px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px}
  h2,h3{margin:0 0 12px 0}
  .doors{display:flex;gap:16px;justify-content:center;margin:12px 0 8px}
  .door{
    width:140px;height:200px;border:2px solid var(--border);border-radius:8px;background:#11162a;
    display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:transform .1s ease, border-color .2s ease;
    user-select:none;
  }
  .door:hover{transform:translateY(-2px);border-color:#33407a}
  .door.disabled{opacity:.6;cursor:not-allowed;transform:none}
  .door .label{position:absolute;top:8px;left:8px;opacity:.6;font-size:12px}
  .door .big{font-size:52px;line-height:1}
  .door.revealed{background:#0e1430;border-color:#3b467d}
  .door.selected{outline:3px solid var(--primary)}
  .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  button{
    background:#0f1836;border:1px solid #2a3250;border-radius:8px;color:#dfe6ff;padding:10px 14px;cursor:pointer;
  }
  button:hover{border-color:#3b4c88}
  button.primary{background:#264880;border-color:#3860aa}
  button.ghost{background:transparent}
  button.danger{background:#2b0e14;border-color:#51232b;color:#ffb3b3}
  .status{margin-top:12px;text-align:center;color:var(--muted);min-height:24px}
  .stats{display:grid;grid-template-columns:1fr;gap:8px;font-size:14px}
  .statRow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .kpi{font-variant-numeric:tabular-nums}
  .bar{height:8px;background:#0e1428;border:1px solid #273059;border-radius:10px;overflow:hidden;min-width:140px}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#2f7dff,#7acbff)}
  .notice{color:#8da3c7;font-size:12px;margin:10px 0 0}
  footer{padding:16px 24px;color:var(--muted);border-top:1px solid var(--border)}
</style>
</head>
<body>
<header>
  <div>
    <h1>Monty Hall — Visual Simulator</h1>
    <div class="sub">Pick a door. The host reveals a goat. Choose to <b>stick</b> or <b>switch</b>. We’ll track results automatically.</div>
  </div>
  <div class="legend">
    <span><i class="dot switch"></i>Switch</span>
    <span><i class="dot stick"></i>Stick</span>
  </div>
</header>

<section class="stage">
  <div class="board" id="board">
    <h2 id="stepTitle">Step 1 — Choose a door</h2>
    <div class="doors" id="doors"></div>
    <div class="controls" id="controls"></div>
    <div class="status" id="status"></div>
  </div>

  <div class="panels">
    <div class="panel">
      <h3>Session Stats</h3>
      <div class="stats" id="sessionStats"></div>
      <div class="controls" style="margin-top:10px">
        <button class="ghost" id="resetRound">Restart round</button>
        <button class="ghost" id="newGame">New game</button>
        <button class="primary" id="autoSim">Run 100 auto-games</button>
      </div>
    </div>

    <div class="panel">
      <h3>All-Time Stats (this device)</h3>
      <div class="stats" id="allTimeStats"></div>
      <div class="controls" style="margin-top:10px">
        <button class="danger" id="resetAll">Reset all-time stats</button>
      </div>
      <p class="notice">We store totals in your browser so they persist between visits. No data leaves your device.</p>
    </div>
  </div>
</section>

<footer>Tip: Statistically, switching wins about 2/3 of the time. Use this tool to see it play out over many games.</footer>

<script>
(function(){
  // ---------- State ----------
  const doorsEl = document.getElementById('doors');
  const controlsEl = document.getElementById('controls');
  const statusEl = document.getElementById('status');
  const stepTitle = document.getElementById('stepTitle');

  const LOCAL_KEY = 'montyHallStats.v1';

  const defaultStats = () => ({
    switch:{ plays:0, wins:0 },
    stick :{ plays:0, wins:0 }
  });

  let session = defaultStats();
  let allTime = loadAllTime();

  const state = {
    phase: 'pick',       // 'pick' -> 'decide' -> 'done'
    carDoor: rand3(),
    initialPick: null,
    revealedDoor: null,  // Monty-revealed goat
    decided: null        // 'switch' | 'stick' | null
  };

  // ---------- Helpers ----------
  function rand3(){ return Math.floor(Math.random()*3); }

  function setStatus(msg){ statusEl.textContent = msg || ''; }

  function pct(wins, plays){
    if (!plays) return '—';
    return ((wins/plays)*100).toFixed(1) + '%';
  }

  function loadAllTime(){
    try{
      const raw = localStorage.getItem(LOCAL_KEY);
      if(!raw) return defaultStats();
      const data = JSON.parse(raw);
      // validate shape
      ['switch','stick'].forEach(k=>{
        if(!data[k] || typeof data[k].plays!=='number' || typeof data[k].wins!=='number'){
          data[k] = {plays:0,wins:0};
        }
      });
      return data;
    }catch(e){
      return defaultStats();
    }
  }

  function saveAllTime(){
    localStorage.setItem(LOCAL_KEY, JSON.stringify(allTime));
  }

  function chooseRevealDoor(carDoor, initialPick){
    // Monty reveals a goat that is not the player's pick
    const candidates = [0,1,2].filter(d => d !== initialPick && d !== carDoor);
    if (candidates.length === 1) return candidates[0]; // player picked goat -> only one possible
    // player picked the car -> Monty can reveal either goat
    return candidates[Math.floor(Math.random()*candidates.length)];
  }

  function otherClosedDoor(initialPick, revealedDoor){
    return [0,1,2].find(d => d !== initialPick && d !== revealedDoor);
  }

  // ---------- Stats API (FIX for the crash) ----------
  function addResult(strategy, didWin){
    // Update session
    session[strategy].plays += 1;
    if (didWin) session[strategy].wins += 1;

    // Update all-time
    allTime[strategy].plays += 1;
    if (didWin) allTime[strategy].wins += 1;

    saveAllTime();
  }

  function renderStats(){
    const s = session, a = allTime;
    const row = (label, obj, tint) => `
      <div class="statRow">
        <div>${label}</div>
        <div class="kpi">${obj.wins} / ${obj.plays} (${pct(obj.wins,obj.plays)})</div>
      </div>
      <div class="bar"><span style="width:${obj.plays? (obj.wins/obj.plays*100):0}%"></span></div>
    `;

    document.getElementById('sessionStats').innerHTML =
      row('<span class="dot switch"></span>Switch', s.switch) +
      row('<span class="dot stick"></span>Stick',  s.stick);

    document.getElementById('allTimeStats').innerHTML =
      row('<span class="dot switch"></span>Switch', a.switch) +
      row('<span class="dot stick"></span>Stick',  a.stick);
  }

  // ---------- UI ----------
  function renderDoors(){
    doorsEl.innerHTML = '';
    for(let i=0;i<3;i++){
      const btn = document.createElement('button');
      btn.className = 'door';
      btn.dataset.idx = String(i);

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = `Door ${i+1}`;
      btn.appendChild(label);

      const glyph = document.createElement('div');
      glyph.className = 'big';
      glyph.textContent = '🚪';
      btn.appendChild(glyph);

      if (state.revealedDoor === i) {
        btn.classList.add('revealed');
        glyph.textContent = (state.carDoor === i ? '🚗' : '🐐');
      }

      if (state.initialPick === i) {
        btn.classList.add('selected');
      }

      if (state.phase === 'pick') {
        btn.addEventListener('click', onPick);
      } else {
        btn.classList.add('disabled');
      }

      doorsEl.appendChild(btn);
    }
  }

  function renderControls(){
    controlsEl.innerHTML = '';
    if (state.phase === 'pick') {
      stepTitle.textContent = 'Step 1 — Choose a door';
      setStatus('Pick any door to start.');
      return;
    }
    if (state.phase === 'decide') {
      stepTitle.textContent = 'Step 2 — Stick or Switch?';
      setStatus('One goat has been revealed. Will you stick with your door or switch to the other closed door?');

      const stickBtn = document.createElement('button');
      stickBtn.textContent = 'Stick';
      stickBtn.className = 'ghost';
      stickBtn.addEventListener('click', ()=>decide('stick'));

      const switchBtn = document.createElement('button');
      switchBtn.textContent = 'Switch';
      switchBtn.className = 'primary';
      switchBtn.addEventListener('click', ()=>decide('switch'));

      controlsEl.appendChild(stickBtn);
      controlsEl.appendChild(switchBtn);
      return;
    }
    if (state.phase === 'done') {
      stepTitle.textContent = 'Result';
      return;
    }
  }

  function onPick(e){
    if(state.phase!=='pick') return;
    const idx = Number(e.currentTarget.dataset.idx);
    state.initialPick = idx;

    // Monty reveals a goat
    state.revealedDoor = chooseRevealDoor(state.carDoor, state.initialPick);
    state.phase = 'decide';
    renderAll();
  }

  function decide(strategy){
    if(state.phase!=='decide') return;

    let finalPick = state.initialPick;
    if (strategy === 'switch') {
      finalPick = otherClosedDoor(state.initialPick, state.revealedDoor);
    }

    const win = (finalPick === state.carDoor);
    addResult(strategy, win);

    // Reveal all doors visually
    state.phase = 'done';
    setStatus(win
      ? (strategy==='switch' ? '✅ You SWITCHED and won the car!' : '✅ You STUCK and won the car!')
      : (strategy==='switch' ? '❌ You SWITCHED and got a goat.' : '❌ You STUCK and got a goat.')
    );

    // Re-render with all reveals
    doorsEl.querySelectorAll('.door').forEach((btn)=>{
      const i = Number(btn.dataset.idx);
      btn.classList.add('revealed','disabled');
      btn.querySelector('.big').textContent = (i===state.carDoor ? '🚗' : '🐐');
    });

    renderStats();
    renderControls();

    // Offer quick “Play again”
    const again = document.createElement('button');
    again.textContent = 'Play again';
    again.className = 'primary';
    again.addEventListener('click', ()=>initRound({ newCar:true }));
    controlsEl.appendChild(again);
  }

  function initRound({newCar=false}={}){
    state.phase = 'pick';
    if (newCar) state.carDoor = rand3();
    state.initialPick = null;
    state.revealedDoor = null;
    state.decided = null;
    renderAll();
  }

  function renderAll(){
    renderDoors();
    renderControls();
  }

  // ---------- Auto-simulation ----------
  const autoSimBtn = document.getElementById('autoSim');

  function autoSimulate(games=100){
    for(let i=0;i<games;i++){
      const carDoor = rand3();
      const initialPick = rand3();
      const reveal = chooseRevealDoor(carDoor, initialPick);
      const switchDoor = otherClosedDoor(initialPick, reveal);

      // Simulate switch
      const switchWin = (switchDoor===carDoor);
      addResult('switch', switchWin);

      // Simulate stick
      const stickWin = (initialPick===carDoor);
      addResult('stick', stickWin);
    }
    renderStats();
    setStatus(`Auto-simulated ${games} games per strategy. Switch vs Stick stats updated.`);
  }

  autoSimBtn.addEventListener('click', ()=>autoSimulate(100));

  // ---------- Top-level controls ----------
  document.getElementById('resetRound').addEventListener('click', ()=>initRound({newCar:false}));
  document.getElementById('newGame').addEventListener('click', ()=>initRound({newCar:true}));
  document.getElementById('resetAll').addEventListener('click', ()=>{
    allTime = defaultStats();
    saveAllTime();
    renderStats();
    setStatus('All-time stats cleared.');
  });

  // ---------- Self-tests (run with ?test=1) ----------
  function approx(a,b,tol){ return Math.abs(a-b) <= tol; }

  function runSelfTests(){
    console.log('Running Monty Hall self-tests…');

    // 1) reveal door never equals initial pick or car
    for (let car=0; car<3; car++){
      for (let pick=0; pick<3; pick++){
        const r = chooseRevealDoor(car, pick);
        console.assert(r !== pick && r !== car, 'Reveal logic invalid', {car,pick,r});
      }
    }

    // 2) switch vs stick win rates roughly converge
    let swWins=0, swPlays=6000, stWins=0, stPlays=6000;
    for (let i=0;i<swPlays;i++){
      const car = rand3();
      const pick = rand3();
      const r = chooseRevealDoor(car, pick);
      const sw = otherClosedDoor(pick, r);
      if (sw===car) swWins++;
    }
    for (let i=0;i<stPlays;i++){
      const car = rand3();
      const pick = rand3();
      if (pick===car) stWins++;
    }
    const swRate = swWins/swPlays, stRate = stWins/stPlays;
    console.assert(approx(swRate, 2/3, 0.05), 'Switch rate not ~2/3', swRate);
    console.assert(approx(stRate, 1/3, 0.05), 'Stick rate not ~1/3', stRate);

    // 3) addResult increments correctly (without mutating stored allTime beyond this test)
    const savedAll = JSON.parse(JSON.stringify(allTime));
    const savedSess = JSON.parse(JSON.stringify(session));
    const before = JSON.stringify({session,allTime});
    addResult('switch', true);
    addResult('stick', false);
    const after = JSON.stringify({session,allTime});
    console.assert(before !== after, 'addResult did not change stats');
    // restore
    allTime = savedAll;
    session = savedSess;
    saveAllTime();
    renderStats();

    console.log('Self-tests complete ✅');
  }

  // expose tests for manual run if needed
  window._montyHallTest = { runSelfTests, chooseRevealDoor, otherClosedDoor };

  // Auto-run tests only if explicitly requested
  const url = new URL(location.href);
  if (url.searchParams.get('test') === '1') {
    runSelfTests();
    setStatus('Self-tests executed. Check console for results.');
  }

  // ---------- Boot ----------
  renderStats();
  initRound({newCar:true});
})();
</script>
</body>
</html>
